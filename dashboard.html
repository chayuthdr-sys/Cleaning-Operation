<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; font-family: 'Sarabun', sans-serif; padding-bottom: 50px; }
    .img-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; cursor: pointer; }
    .d-none-custom { display: none !important; }
  </style>
</head>
<body>
  <div class="container-fluid mt-4">
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0 text-primary fw-bold">üìä Dashboard</h4>
          <button class="btn btn-primary btn-sm" onclick="loadData()">üîÑ Refresh</button>
        </div>
        <div class="d-flex gap-3 align-items-end flex-wrap">
          <div>
            <label class="form-label small text-muted">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
            <input type="date" id="filterDate" class="form-control form-control-sm" onchange="loadData()">
          </div>
          <div style="min-width: 150px;">
             <label class="form-label small text-muted">‡πÅ‡∏ú‡∏ô‡∏Å</label>
             <select id="filterDept" class="form-select form-select-sm" onchange="loadData()"><option value="All">Loading...</option></select>
          </div>
          <button id="btnMissing" class="btn btn-outline-danger btn-sm d-none-custom" onclick="loadMissing()">‚ö†Ô∏è Check Missing</button>
        </div>
      </div>
    </div>

    <div id="monthlyBox" class="alert alert-light border shadow-sm d-none-custom mb-4">
      <div class="d-flex justify-content-between align-items-center">
        <div><h5 class="mb-1">üìÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h5><div id="monthlyStatusText">...</div></div>
        <button id="btnMonthlyApprove" class="btn btn-success" onclick="openApproveModal()">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body p-0 table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light"><tr><th>Time</th><th>Task Info</th><th>Compare</th><th>Worker</th><th>Status</th></tr></thead>
          <tbody id="logTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="modal fade" id="approveModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">üì∏ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><input type="file" id="mgrFile" accept="image/*" capture="environment" class="form-control"></div><div class="modal-footer"><button class="btn btn-success" onclick="confirmApprove()">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div></div></div></div>
  <div class="modal fade" id="missingModal" tabindex="-1"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header bg-danger text-white"><h5 class="modal-title">‚ö†Ô∏è ‡∏á‡∏≤‡∏ô‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><ul id="missingList" class="list-group list-group-flush"></ul></div></div></div></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentUserRole = '';
    let approveModalInstance, missingModalInstance;

    window.onload = function() {
      document.getElementById('filterDate').value = new Date().toISOString().split('T')[0];
      approveModalInstance = new bootstrap.Modal(document.getElementById('approveModal'));
      missingModalInstance = new bootstrap.Modal(document.getElementById('missingModal'));
      
      google.script.run.withSuccessHandler(depts => {
        const sel = document.getElementById('filterDept');
        sel.innerHTML = '<option value="All">--- ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å ---</option>';
        depts.forEach(d => sel.innerHTML += `<option value="${d}">${d}</option>`);
        loadData();
      }).getAllDepartments();
    }

    function loadData() {
      const date = document.getElementById('filterDate').value;
      const dept = document.getElementById('filterDept') ? document.getElementById('filterDept').value : 'All';
      document.getElementById('logTable').innerHTML = '<tr><td colspan="5" class="text-center p-4">Loading...</td></tr>';
      google.script.run.withSuccessHandler(renderDashboard).getDashboardData(date, dept);
    }

    function renderDashboard(data) {
      currentUserRole = data.viewerRole;
      const rows = data.rows;
      const mStatus = data.monthlyStatus;

      const btnMissing = document.getElementById('btnMissing');
      const monthlyBox = document.getElementById('monthlyBox');
      const deptFilter = document.getElementById('filterDept');

      // QA
      if (currentUserRole === 'QA') {
        btnMissing.classList.remove('d-none-custom');
        deptFilter.disabled = false;
      } else {
        btnMissing.classList.add('d-none-custom');
      }

      // Manager
      if (currentUserRole === 'Manager') {
        monthlyBox.classList.remove('d-none-custom');
        deptFilter.value = data.viewerDept || 'All';
        deptFilter.disabled = true;

        const btnApprove = document.getElementById('btnMonthlyApprove');
        const txtStatus = document.getElementById('monthlyStatusText');
        if (mStatus.isApproved) {
          btnApprove.style.display = 'none';
          txtStatus.innerHTML = `<span class="badge bg-success">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span> <a href="${mStatus.mgrPhoto}" target="_blank">‡∏£‡∏π‡∏õ</a>`;
        } else {
          btnApprove.style.display = 'block';
          txtStatus.innerHTML = `<span class="badge bg-secondary">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>`;
        }
      } else {
        monthlyBox.classList.add('d-none-custom');
      }

      const tbody = document.getElementById('logTable');
      tbody.innerHTML = '';
      if (rows.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted p-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>'; return; }

      rows.forEach(row => {
        const time = row.timestamp.includes(' ') ? row.timestamp.split(' ')[1] : row.timestamp;
        // [UPDATED] ‡πÄ‡∏û‡∏¥‡πà‡∏° Location Name ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î Task ID ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á
        tbody.innerHTML += `<tr>
          <td>${time}</td>
          <td>
            <span class="badge bg-info text-dark">${row.dept}</span>
            <div class="small text-muted mt-1">${row.taskID}</div>
            <strong>${row.location}</strong>
          </td>
          <td><div class="d-flex gap-2"><img src="${row.stdImg}" class="img-thumb" onclick="window.open(this.src)"><img src="${row.photoUrl}" class="img-thumb border-success" onclick="window.open(this.src)"></div></td>
          <td>${row.name}<br><small class="text-muted">${row.position}</small></td>
          <td><span class="text-success small">‚úî Recorded</span></td>
        </tr>`;
      });
    }

    function openApproveModal() { document.getElementById('mgrFile').value = ''; approveModalInstance.show(); }
    function confirmApprove() {
       const file = document.getElementById('mgrFile').files[0];
       if(!file) return alert("‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ");
       const dateVal = document.getElementById('filterDate').value;
       const deptVal = document.getElementById('filterDept').value;
       
       const reader = new FileReader();
       reader.readAsDataURL(file);
       reader.onload = e => {
         const img = new Image(); img.src = e.target.result;
         img.onload = () => {
            const c=document.createElement('canvas'); const max=800; let w=img.width,h=img.height;
            if(w>max){h*=max/w;w=max;} c.width=w;c.height=h; c.getContext('2d').drawImage(img,0,0,w,h);
            google.script.run.withSuccessHandler(()=>{ alert("Approved!"); approveModalInstance.hide(); loadData(); }).approveMonthly({ month: dateVal.slice(0,7), dept: deptVal, imageBase64: c.toDataURL('image/jpeg',0.7) });
         }
       }
    }

    function loadMissing() {
      google.script.run.withSuccessHandler(res => {
         const list = document.getElementById('missingList');
         list.innerHTML = res.missingList.length ? '' : '<li class="list-group-item text-center text-success">‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô!</li>';
         // [UPDATED] ‡πÄ‡∏û‡∏¥‡πà‡∏° Task ID ‡πÉ‡∏ô‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö
         res.missingList.forEach(x => list.innerHTML += `
           <li class="list-group-item d-flex justify-content-between align-items-center">
             <div>
               <strong>${x.location}</strong>
               <span class="ms-2 text-muted small">(${x.taskID})</span>
             </div>
             <span class="badge bg-danger">${x.dept}</span>
           </li>`);
         missingModalInstance.show();
      }).getMissingReport();
    }
  </script>
</body>
</html>
