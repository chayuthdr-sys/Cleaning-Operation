<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; font-family: 'Sarabun', sans-serif; padding-bottom: 50px; }
    .img-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; cursor: pointer; }
    .d-none-custom { display: none !important; }
  </style>
</head>
<body>
  <div class="container-fluid mt-4">
    
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0 text-primary fw-bold">üìä Dashboard</h4>
          <button class="btn btn-primary btn-sm" onclick="forceRefresh()">üîÑ Refresh</button>
        </div>

        <div class="d-flex gap-3 align-items-end flex-wrap">
          
          <div>
            <label class="form-label small text-muted">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</label>
            <input type="date" id="filterDate" class="form-control form-control-sm" onchange="loadData()">
          </div>

          <div style="min-width: 150px;">
             <label class="form-label small text-muted">‡πÅ‡∏ú‡∏ô‡∏Å</label>
             <select id="filterDept" class="form-select form-select-sm" onchange="loadData()">
               <option value="All">--- ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å ---</option>
               </select>
          </div>
          
          <button id="btnMissing" class="btn btn-outline-danger btn-sm d-none-custom" onclick="loadMissing()">
            ‚ö†Ô∏è Check Missing (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô)
          </button>
        </div>
      </div>
    </div>

    <div id="monthlyBox" class="alert alert-light border shadow-sm d-none-custom mb-4">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-1">üìÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (<span id="lblMonth">--</span>)</h5>
          <div id="monthlyStatusText">...</div>
        </div>
        <button id="btnMonthlyApprove" class="btn btn-success" onclick="openApproveModal()">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body p-0 table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>Time</th>
              <th>Task Info</th>
              <th>Compare</th>
              <th>Worker</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="logTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="modal fade" id="approveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">üì∏ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <input type="file" id="mgrFile" accept="image/*" capture="environment" class="form-control mb-3">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-success" onclick="confirmApprove()">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="missingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">‚ö†Ô∏è ‡∏á‡∏≤‡∏ô‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body"><ul id="missingList" class="list-group list-group-flush"></ul></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    let currentUserRole = '';
    let approveModalInstance;
    let missingModalInstance;

    window.onload = function() {
      // 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Default ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)
      const now = new Date();
      document.getElementById('filterDate').value = now.toISOString().split('T')[0];

      // 2. ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å‡πÉ‡∏™‡πà Dropdown
      google.script.run.withSuccessHandler(populateDept).getAllDepartments();

      // 3. Init Modals
      approveModalInstance = new bootstrap.Modal(document.getElementById('approveModal'));
      missingModalInstance = new bootstrap.Modal(document.getElementById('missingModal'));
      
      loadData();
    }

    function populateDept(depts) {
      const select = document.getElementById('filterDept');
      depts.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.innerText = d;
        select.appendChild(opt);
      });
    }

    // [FIX ‡∏Ç‡πâ‡∏≠ 1] ‡∏õ‡∏∏‡πà‡∏° Refresh ‡∏à‡∏∞‡πÑ‡∏°‡πà Reset ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß
    function forceRefresh() {
        loadData();
    }

   function loadData() {
      const date = document.getElementById('filterDate').value;
      const deptEl = document.getElementById('filterDept');
      const dept = deptEl ? deptEl.value : 'All'; 

      // --- üîç LOG 1: ‡∏î‡∏π‡∏Ñ‡πà‡∏≤‡∏ù‡∏±‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô ---
      console.log("üöÄ CLIENT START");
      console.log("1. Date Value:", date);
      console.log("2. Dept Value (‡∏à‡∏≤‡∏Å Dropdown):", dept);
      console.log("3. ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏≤ Server...");
      // --------------------------------

      document.getElementById('logTable').innerHTML = '<tr><td colspan="5" class="text-center p-4">Loading data...</td></tr>';
      
      google.script.run
        .withSuccessHandler((res) => {
           console.log("‚úÖ CLIENT SUCCESS: ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß", res); // ‡∏î‡∏π‡∏ß‡πà‡∏≤ Server ‡∏™‡πà‡∏á‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
           renderDashboard(res);
        })
        .withFailureHandler(err => {
           console.error("‚ùå CLIENT ERROR:", err);
           document.getElementById('logTable').innerHTML = `Error: ${err}`;
        })
        .getDashboardData(date, dept); 
    }

    function renderDashboard(data) {
      const rows = data.rows;
      currentUserRole = data.viewerRole;
      const mStatus = data.monthlyStatus;

      // --- UI Permission ---
      const btnMissing = document.getElementById('btnMissing');
      const monthlyBox = document.getElementById('monthlyBox');
      const deptFilter = document.getElementById('filterDept');

      // QA Logic
      if (currentUserRole === 'QA') {
        btnMissing.classList.remove('d-none-custom');
        deptFilter.disabled = false; // QA ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡πÑ‡∏î‡πâ
      } else {
        btnMissing.classList.add('d-none-custom');
      }
      
      // Manager Logic
      if (currentUserRole === 'Manager') {
        monthlyBox.classList.remove('d-none-custom');
        // Manager ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏•‡πá‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà All ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏ï‡∏≤‡∏° Logic Server)
        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô: ‡πÄ‡∏£‡∏≤‡∏≠‡∏≤‡∏à‡∏à‡∏∞ Disable dropdown ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
        deptFilter.value = data.viewerDept; // ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á
        deptFilter.disabled = true; // ‡∏•‡πá‡∏≠‡∏Å

        // Setup Box
        document.getElementById('lblMonth').innerText = document.getElementById('filterDate').value.slice(0, 7) || 'All Time';
        const btnApprove = document.getElementById('btnMonthlyApprove');
        const txtStatus = document.getElementById('monthlyStatusText');

        if (mStatus.isApproved) {
          btnApprove.style.display = 'none';
          txtStatus.innerHTML = `<span class="badge bg-success">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span> <a href="${mStatus.mgrPhoto}" target="_blank">‡∏£‡∏π‡∏õ</a>`;
        } else {
          btnApprove.style.display = 'block';
          txtStatus.innerHTML = `<span class="badge bg-secondary">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</span>`;
        }
      } else {
        monthlyBox.classList.add('d-none-custom');
      }

      // --- Render Table ---
      const tbody = document.getElementById('logTable');
      tbody.innerHTML = '';

      if (rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted p-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
        return;
      }

      rows.forEach(row => {
        const time = row.timestamp.includes(' ') ? row.timestamp.split(' ')[1] : row.timestamp;
        const html = `
          <tr>
            <td>${time}</td>
            <td>
              <span class="badge bg-info text-dark">${row.dept}</span><br>
              <strong>${row.taskID}</strong>
            </td>
            <td>
              <div class="d-flex gap-2">
                <div class="text-center"><img src="${row.stdImg}" class="img-thumb" onclick="window.open(this.src)"></div>
                <div class="text-center"><img src="${row.photoUrl}" class="img-thumb border-success" onclick="window.open(this.src)"></div>
              </div>
            </td>
            <td>${row.name}<br><small class="text-muted">${row.position}</small></td>
            <td><span class="text-success small">‚úî Recorded</span></td>
          </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', html);
      });
    }

    // (Code Modal Approve / Missing ‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏° ... Copy ‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö)
    function openApproveModal() { document.getElementById('mgrFile').value = ''; approveModalInstance.show(); }
    
    function confirmApprove() {
       const file = document.getElementById('mgrFile').files[0];
       if(!file) return alert("Please take a photo");
       const dateVal = document.getElementById('filterDate').value;
       if(!dateVal) return alert("Please select a date first");
       
       const reader = new FileReader();
       reader.readAsDataURL(file);
       reader.onload = e => {
         const img = new Image(); img.src = e.target.result;
         img.onload = () => {
            const c=document.createElement('canvas'); const max=800; let w=img.width,h=img.height;
            if(w>max){h*=max/w;w=max;} c.width=w;c.height=h; c.getContext('2d').drawImage(img,0,0,w,h);
            
            // ‡∏™‡πà‡∏á filterDept ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô QA ‡πÅ‡∏ï‡πà‡∏õ‡∏Å‡∏ï‡∏¥ Manager ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å Dept ‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏µ‡πà Server
            // ‡πÄ‡∏£‡∏≤‡∏™‡πà‡∏á dept ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ global ‡∏´‡∏£‡∏∑‡∏≠ server session ‡∏Å‡πá‡πÑ‡∏î‡πâ
            // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢ Manager ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏ú‡∏ô‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÄ‡∏™‡∏°‡∏≠
            
            google.script.run.withSuccessHandler(()=>{ 
               alert("Approved!"); approveModalInstance.hide(); loadData(); 
            }).approveMonthly({ month: dateVal.slice(0,7), dept: document.getElementById('filterDept').value, imageBase64: c.toDataURL('image/jpeg',0.7) });
         }
       }
    }

    function loadMissing() {
      google.script.run.withSuccessHandler(res => {
         const list = document.getElementById('missingList');
         list.innerHTML = res.missingList.length ? '' : '<li class="list-group-item text-center text-success">‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô!</li>';
         res.missingList.forEach(x => list.insertAdjacentHTML('beforeend', `<li class="list-group-item d-flex justify-content-between"><span>${x.location}</span><span class="badge bg-danger">${x.dept}</span></li>`));
         missingModalInstance.show();
      }).getMissingReport();
    }
  </script>
</body>
</html>
