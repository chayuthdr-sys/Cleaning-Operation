<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; font-family: 'Sarabun', sans-serif; padding-bottom: 50px; }
    .img-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; cursor: pointer; }
    .d-none-custom { display: none !important; }
    .table > :not(caption) > * > * { padding: 0.75rem 0.5rem; }
  </style>
</head>
<body>
  <div class="container-fluid mt-4">
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0 text-primary fw-bold">üìä Dashboard</h4>
          <button class="btn btn-primary btn-sm" onclick="loadData()">üîÑ Refresh</button>
        </div>
        <div class="d-flex gap-2 align-items-end flex-wrap">
          <div>
            <label class="form-label small text-muted">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Shift Date)</label>
            <input type="date" id="filterDate" class="form-control form-control-sm" onchange="loadData()">
          </div>
          
          <div style="min-width: 120px;">
             <label class="form-label small text-muted">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏Å‡∏∞)</label>
             <select id="filterShift" class="form-select form-select-sm" onchange="loadData()">
               <option value="All">--- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ---</option>
               <option value="Day">üåû ‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤ (06:00-18:00)</option>
               <option value="Night">üåú ‡∏Å‡∏∞‡∏î‡∏∂‡∏Å (18:00-06:00)</option>
             </select>
          </div>

          <div style="min-width: 150px;">
             <label class="form-label small text-muted">‡πÅ‡∏ú‡∏ô‡∏Å</label>
             <select id="filterDept" class="form-select form-select-sm" onchange="loadData()"><option value="All">Loading...</option></select>
          </div>
          <button id="btnMissing" class="btn btn-outline-danger btn-sm d-none-custom" onclick="loadMissing()">‚ö†Ô∏è Check Missing</button>
        </div>
      </div>
    </div>

    <div id="monthlyBox" class="alert alert-light border shadow-sm d-none-custom mb-4">
      <div class="d-flex justify-content-between align-items-center">
        <div><h5 class="mb-1">üìÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h5><div id="monthlyStatusText">...</div></div>
        <button id="btnMonthlyApprove" class="btn btn-success" onclick="openApproveModal()">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body p-0 table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>Time / Shift</th> <th>Task Info</th>
              <th>üßπ Staff</th>
              <th>‚úÖ Worker</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="logTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="modal fade" id="approveModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">üì∏ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><input type="file" id="mgrFile" accept="image/*" capture="environment" class="form-control"></div><div class="modal-footer"><button class="btn btn-success" onclick="confirmApprove()">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div></div></div></div>
  
  <div class="modal fade" id="missingModal" tabindex="-1"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header bg-danger text-white"><h5 class="modal-title">‚ö†Ô∏è ‡∏á‡∏≤‡∏ô‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><ul id="missingList" class="list-group list-group-flush"></ul></div></div></div></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentUserRole = '';
    let approveModalInstance, missingModalInstance;

    window.onload = function() {
      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Shift Date Logic ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ó‡∏≥‡πÉ‡∏ô Server ‡πÅ‡∏ï‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô)
      document.getElementById('filterDate').value = new Date().toISOString().split('T')[0];
      approveModalInstance = new bootstrap.Modal(document.getElementById('approveModal'));
      missingModalInstance = new bootstrap.Modal(document.getElementById('missingModal'));
      
      google.script.run.withSuccessHandler(depts => {
        const sel = document.getElementById('filterDept');
        sel.innerHTML = '<option value="All">--- ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å ---</option>';
        depts.forEach(d => sel.innerHTML += `<option value="${d}">${d}</option>`);
        loadData();
      }).getAllDepartments();
    }

    function loadData() {
      const date = document.getElementById('filterDate').value;
      const dept = document.getElementById('filterDept') ? document.getElementById('filterDept').value : 'All';
      const shift = document.getElementById('filterShift').value; // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ Shift
      
      document.getElementById('logTable').innerHTML = '<tr><td colspan="5" class="text-center p-4">Loading...</td></tr>';
      
      // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ shift ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
      google.script.run.withSuccessHandler(renderDashboard).getDashboardData(date, dept, shift);
    }

    function renderDashboard(data) {
      currentUserRole = data.viewerRole;
      const rows = data.rows;
      const mStatus = data.monthlyStatus;

      const btnMissing = document.getElementById('btnMissing');
      const monthlyBox = document.getElementById('monthlyBox');
      const deptFilter = document.getElementById('filterDept');

      // QA
      if (currentUserRole === 'QA') {
        btnMissing.classList.remove('d-none-custom');
        deptFilter.disabled = false;
      } else {
        btnMissing.classList.add('d-none-custom');
      }

      // Manager
      if (currentUserRole === 'Manager') {
        monthlyBox.classList.remove('d-none-custom');
        deptFilter.value = data.viewerDept || 'All';
        deptFilter.disabled = true;
        // ... (Monthly logic same as before) ...
      } else {
        monthlyBox.classList.add('d-none-custom');
      }

      const tbody = document.getElementById('logTable');
      tbody.innerHTML = '';
      if (rows.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted p-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>'; return; }

      rows.forEach(row => {
        // Staff Status Badge
        let staffStatusHtml = '';
        if (row.consistency === 'OK') {
            staffStatusHtml = `<span class="badge bg-success bg-opacity-10 text-success border border-success">‚úî ${row.staffTime}</span>`;
        } else if (row.consistency === 'Late') {
            staffStatusHtml = `<span class="badge bg-warning text-dark">‚ö†Ô∏è ${row.staffTime}</span>`;
        } else if (row.consistency === 'Missing') {
            staffStatusHtml = `<span class="badge bg-secondary">‚ùå</span>`;
        }

        tbody.innerHTML += `<tr>
          <td>
             <div class="fw-bold text-primary">${row.timeOnly}</div>
             <span class="badge bg-light text-dark border">${row.shiftLabel}</span>
          </td>
          <td>
            <strong>${row.location}</strong>
            <div class="small text-muted">${row.taskID}</div>
            <span class="badge bg-info text-dark mt-1">${row.dept}</span>
          </td>
          <td>
             ${staffStatusHtml}
             <div class="small text-muted mt-1" style="font-size:0.75rem">${row.staffUser}</div>
          </td>
          <td>
             <div class="fw-bold small">${row.name}</div>
             <div class="d-flex gap-2 mt-1">
               <img src="${row.photoUrl}" class="img-thumb border-success" onclick="window.open(this.src)">
             </div>
          </td>
          <td><span class="text-success small fw-bold">‚úî OK</span></td>
        </tr>`;
      });
    }

    // [UPDATED] Check Missing with Shift
    function loadMissing() {
      const date = document.getElementById('filterDate').value;
      const shift = document.getElementById('filterShift').value; // ‡πÄ‡∏≠‡∏≤‡∏Ñ‡πà‡∏≤‡∏Å‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ
      
      if (shift === 'All') {
         if(!confirm('‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤" ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏ó‡∏≥‡πÄ‡∏•‡∏¢‡∏ï‡∏•‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
      }

      google.script.run.withSuccessHandler(res => {
         const list = document.getElementById('missingList');
         const shiftText = res.checkedShift === 'Day' ? '‡∏Å‡∏∞‡πÄ‡∏ä‡πâ‡∏≤' : (res.checkedShift === 'Night' ? '‡∏Å‡∏∞‡∏î‡∏∂‡∏Å' : '‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô');
         
         if (res.missingList.length === 0) {
            list.innerHTML = `<li class="list-group-item text-center text-success">
               <strong>‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! üëè</strong><br>‡∏á‡∏≤‡∏ô${shiftText}‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
            </li>`;
         } else {
            list.innerHTML = `<li class="list-group-item bg-light fw-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô (${shiftText})</li>`;
            res.missingList.forEach(x => list.innerHTML += `
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong>${x.location}</strong>
                  <span class="ms-2 text-muted small">(${x.taskID})</span>
                </div>
                <span class="badge bg-danger">${x.dept}</span>
              </li>`);
         }
         missingModalInstance.show();
      }).getMissingReport(date, shift);
    }
  </script>
</body>
</html>
