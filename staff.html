<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; font-family: 'Sarabun', sans-serif; }
    .status-done { background-color: #d1e7dd; color: #0f5132; } /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à */
    .btn-action { width: 150px; }
  </style>
</head>
<body>
  <div class="container mt-5">
    <div class="card shadow">
      <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h4 class="mb-0">üßπ ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î (Staff)</h4>
        <button class="btn btn-sm btn-light" onclick="loadData()">üîÑ Refresh</button>
      </div>
      <div class="card-body">
        <p class="text-muted">‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° <strong>"‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à"</strong> ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡πà‡∏≤‡∏ô‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏à‡∏∏‡∏î‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
        
        <div class="table-responsive">
          <table class="table table-bordered table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th style="width: 50%">‡∏à‡∏∏‡∏î‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î (Location)</th>
                <th style="width: 20%">‡πÅ‡∏ú‡∏ô‡∏Å</th>
                <th style="width: 30%">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</th>
              </tr>
            </thead>
            <tbody id="taskList">
              <tr><td colspan="3" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    window.onload = loadData;

    function loadData() {
      google.script.run.withSuccessHandler(renderTable).getStandardsData();
    }

    function renderTable(tasks) {
      const tbody = document.getElementById('taskList');
      tbody.innerHTML = '';

      if (tasks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏Ñ‡∏∏‡∏ì</td></tr>';
        return;
      }

      tasks.forEach(task => {
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        const isFinished = task.isStaffReady || task.isDone;
        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡πÅ‡∏ñ‡∏ß: ‡∏ñ‡πâ‡∏≤ Staff ‡∏Å‡∏î‡πÅ‡∏•‡πâ‡∏ß (isStaffReady) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏¢
        const rowClass = isFinished ? 'table-success' : '';
        
        let btnHtml = '';
        if (task.isDone) {
            // Worker ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß
            btnHtml = '<span class="badge bg-success">‚úî ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</span><br><small class="text-muted">(‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß)</small>';
        } else if (task.isStaffReady) {
            // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ] Staff ‡∏Å‡∏î‡πÅ‡∏•‡πâ‡∏ß -> ‡∏Ç‡∏∂‡πâ‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
            btnHtml = `
              <button class="btn btn-success btn-action disabled">
                 ‚úÖ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
              </button>
              <div class="small text-muted mt-1">‡∏£‡∏≠‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>
            `;
        } else {
            // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥
            btnHtml = `<button id="btn_${task.taskID}" class="btn btn-primary btn-action" onclick="submitWork('${task.taskID}', '${task.location}', '${task.department}')">‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à</button>`;
        }

        const html = `
          <tr class="${rowClass}">
            <td>
              <strong>${task.location}</strong><br>
              <small class="text-muted">${task.desc}</small>
            </td>
            <td><span class="badge bg-info text-dark">${task.department}</span></td>
            <td class="text-center align-middle">${btnHtml}</td>
          </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', html);
      });
    }

    function submitWork(id, loc, dept) {
      if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î "' + loc + '" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß?')) return;

      const btn = document.getElementById('btn_' + id);
      btn.disabled = true;
      btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

      google.script.run.withSuccessHandler(() => {
        loadData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
      }).saveStaffLog(id, loc, dept);
    }
  </script>
</body>
</html>
