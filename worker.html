<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Worker App (Time Check)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

  <style>
    body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; padding-bottom: 60px; }
    .card-task { border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; background: white; }
    .img-preview { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; background: #eee; }
    #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:999; display:flex; justify-content:center; align-items:center; flex-direction: column; }
    
    /* Status Text Styles */
    .status-pass { color: #198754; font-size: 0.85rem; font-weight: bold; display: none; margin-top: 5px; text-align: center;}
    .status-fail { color: #dc3545; font-size: 0.85rem; font-weight: bold; display: none; margin-top: 5px; text-align: center;}
  </style>
</head>
<body>

  <div id="loader">
    <div class="spinner-border text-primary mb-2"></div>
    <div class="fw-bold text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  </div>

  <div class="container py-4" style="max-width: 600px;">
    <h4 class="text-center fw-bold mb-4">‚ú® ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ß‡∏•‡∏≤ 6 ‡∏ä‡∏°.)</h4>
    <div id="app-content"></div>
  </div>

  <script>
    window.onload = function() {
      loadData();
    };

    function loadData() {
      google.script.run
        .withSuccessHandler(renderList)
        .withFailureHandler(showError)
        .getStandardsData();
    }

    function renderList(tasks) {
      const container = document.getElementById('app-content');
      document.getElementById('loader').style.display = 'none';
      container.innerHTML = '';

      if (!tasks || tasks.length === 0) {
        container.innerHTML = '<div class="alert alert-warning text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>';
        return;
      }

      tasks.forEach(task => {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡πà‡∏≤‡∏á‡πÜ
        const isDone = task.isDone;
        const isStaffReady = task.isStaffReady; // [NEW] ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å Staff
        
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Class ‡πÅ‡∏•‡∏∞ Text ‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        const btnClass = isDone ? 'btn-success' : 'btn-primary';
        const btnText = isDone ? '‚úÖ ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ disable ‡∏õ‡∏∏‡πà‡∏°
        const btnDisabled = isDone ? 'disabled' : 'disabled'; // (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô disable ‡∏£‡∏≠‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢)
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏ã‡πà‡∏≠‡∏ô input file
        const inputDisplay = isDone ? 'display:none;' : '';
        // ‡∏ï‡∏Å‡πÅ‡∏ï‡πà‡∏á Card ‡∏ñ‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
        const cardClass = isDone ? 'border-success' : '';
        const bgClass = isDone ? 'bg-opacity-10 bg-success' : 'bg-white';

        // [NEW] ‡∏™‡∏£‡πâ‡∏≤‡∏á Badge ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        let statusBadge = '';
        if (isDone) {
            statusBadge = '<span class="badge bg-success mt-1">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>';
        } else if (isStaffReady) {
            // Staff ‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à
            statusBadge = '<span class="badge bg-warning text-dark mt-1 border border-dark">üßπ ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</span>';
        }

        const html = `
          <div class="card card-task p-3 ${cardClass} ${bgClass}">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <h6 class="m-0 fw-bold">${task.location}</h6>
                <span class="badge bg-info text-dark mt-1">${task.department}</span>
                ${statusBadge}
              </div>
              <span class="badge bg-light text-dark border">${task.taskID}</span>
            </div>
            
            <div class="row g-2 mb-3">
              <div class="col-6 text-center">
                <small class="d-block mb-1">‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô</small>
                <img src="${task.stdImg}" class="img-preview" onclick="window.open(this.src)">
              </div>
              
              ${!isDone ? `
              <div class="col-6 text-center">
                <small class="d-block mb-1">‡∏ñ‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á</small>
                <img id="preview_${task.taskID}" src="https://via.placeholder.com/300x200?text=Camera" class="img-preview">
              </div>
              ` : ''}
            </div>

            <input type="file" id="file_${task.taskID}" class="form-control mb-2" accept="image/*" capture="environment" 
                   onchange="handleFile(this, '${task.taskID}')" style="${inputDisplay}">
            
            <div id="msg_${task.taskID}">
               <div class="status-pass">‚úÖ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà)</div>
               <div class="status-fail">‚ùå Error</div>
            </div>

            <button id="btn_${task.taskID}" class="btn ${btnClass} w-100 mt-2" ${btnDisabled} onclick="sendData('${task.taskID}', '${task.department}')">
              ${btnText}
            </button>
          </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
      });
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ (Logic 6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á) ---
    function handleFile(input, id) {
      const file = input.files[0];
      const preview = document.getElementById('preview_' + id);
      const btn = document.getElementById('btn_' + id);
      const passMsg = document.querySelector(`#msg_${id} .status-pass`);
      const failMsg = document.querySelector(`#msg_${id} .status-fail`);

      // Reset UI
      passMsg.style.display = 'none';
      failMsg.style.display = 'none';
      btn.disabled = true;

      if(file) {
        // 1. ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ Preview
        const reader = new FileReader();
        reader.onload = e => preview.src = e.target.result;
        reader.readAsDataURL(file);

        // 2. ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ EXIF ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ß‡∏•‡∏≤
        EXIF.getData(file, function() {
          const dateTaken = EXIF.getTag(this, "DateTimeOriginal");
          
          if (!dateTaken) {
            failMsg.innerText = "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û (‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ Screenshot/Line)";
            failMsg.style.display = 'block';
            return; 
          }

          // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å EXIF (Format: "YYYY:MM:DD HH:MM:SS")
          const str = dateTaken.split(" ");
          const dateStr = str[0].replace(/:/g, "/");
          const timeStr = str[1];
          
          const photoDate = new Date(dateStr + " " + timeStr);
          const now = new Date();
          
          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (‡∏´‡∏ô‡πà‡∏ß‡∏¢: ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)
          const diffHours = (now - photoDate) / (1000 * 60 * 60);

          console.log(`Task ${id}: Diff ${diffHours.toFixed(2)} hrs`);

          if (diffHours > 6) {
             failMsg.innerText = `‚õî ‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (${diffHours.toFixed(1)} ‡∏ä‡∏°.) ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô 6 ‡∏ä‡∏°.`;
             failMsg.style.display = 'block';
          } else if (diffHours < -1) {
             failMsg.innerText = "‚õî ‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï?)";
             failMsg.style.display = 'block';
          } else {
             passMsg.style.display = 'block';
             btn.disabled = false; // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏°
          }
        });
      }
    }

    function sendData(id, dept) {
      const btn = document.getElementById('btn_'+id);
      const file = document.getElementById('file_'+id).files[0];
      
      btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...';
      btn.disabled = true;

      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = e => {
        const img = new Image();
        img.src = e.target.result;
        img.onload = () => {
          const cvs = document.createElement('canvas');
          const scale = 800 / img.width;
          cvs.width = 800; 
          cvs.height = img.height * scale;
          cvs.getContext('2d').drawImage(img, 0, 0, cvs.width, cvs.height);
          
          google.script.run.withSuccessHandler(() => {
             alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
             btn.innerText = '‚úÖ ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß';
             btn.classList.replace('btn-primary', 'btn-success');
             // ‡∏ã‡πà‡∏≠‡∏ô input file ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à
             const input = document.getElementById('file_'+id);
             if(input) input.style.display = 'none';
             
             // [Optional] ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡πâ‡∏≤‡∏¢‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
             // ‡πÅ‡∏ï‡πà‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏£‡∏≤‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÑ‡∏ß‡πâ‡∏´‡∏£‡∏∑‡∏≠ Reload ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏≠‡∏≤‡∏Å‡πá‡πÑ‡∏î‡πâ
          }).saveLog({
             taskID: id,
             department: dept,
             imageBase64: cvs.toDataURL('image/jpeg', 0.6)
          });
        }
      }
    }

    function showError(e) {
      alert("Error: " + e);
      document.getElementById('loader').innerHTML = `<div class="text-danger p-3">‚ùå ${e}</div>`;
    }
  </script>
</body>
</html>
