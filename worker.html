<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cleaning App</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <style>
    body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; padding-bottom: 80px; }
    #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.98); z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    .card-task { border: none; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 24px; overflow: hidden; background: #fff; }
    .card-header-custom { background-color: #fff; padding: 16px 20px; border-bottom: 1px solid #f0f0f0; }
    .badge-dept { background-color: #e3f2fd; color: #0d47a1; padding: 4px 10px; border-radius: 20px; font-weight: 600; display: inline-block; margin-top: 5px; }
    .compare-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 15px 20px; background-color: #fafafa; }
    .img-wrapper img { width: 100%; height: 150px; object-fit: cover; border-radius: 10px; border: 1px solid #e0e0e0; }
    .control-area { padding: 20px; }
    .status-pass { color: #198754; font-weight: bold; display: none; }
    .status-fail { color: #dc3545; font-weight: bold; display: none; }
  </style>
</head>
<body>
  <div id="loading-overlay">
    <div class="spinner-border text-primary mb-3"></div>
    <div class="text-muted fw-bold">üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î... (V4 Final)</div>
  </div>
  <div class="container py-4" style="max-width: 600px;">
    <h4 class="fw-bold text-center text-dark mb-4">‚ú® ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î</h4>
    <div id="taskList"></div>
  </div>
  <script>
    function startApp() {
      google.script.run
        .withSuccessHandler(renderTasks)
        .withFailureHandler(showFatalError)
        .getStandardsData();
    }

    function renderTasks(tasks) {
      const container = document.getElementById('taskList');
      document.getElementById('loading-overlay').style.display = 'none';
      container.innerHTML = '';

      if (!tasks || tasks.length === 0) {
        container.innerHTML = '<div class="alert alert-warning text-center">üéâ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</div>';
        return;
      }

      tasks.forEach((task) => {
        const safeDept = task.department || 'General';
        const safeImg = task.stdImg || 'https://via.placeholder.com/300x300?text=No+Standard';
        const isDone = task.isDone; 
        const statusBadge = isDone ? '<span class="badge bg-success float-end">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>' : '<span class="badge bg-secondary float-end opacity-50">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à</span>';
        const btnDisabled = isDone ? 'disabled' : '';
        const btnText = isDone ? '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
        const btnClass = isDone ? 'btn-secondary' : 'btn-primary';

        const html = `
          <div class="card card-task">
            <div class="card-header-custom">
              <div class="d-flex justify-content-between align-items-start">
                <div><h6 class="m-0 fw-bold text-dark">üìç ${task.location}</h6><span class="badge-dept mt-2">üè¢ ${safeDept}</span></div>
                <span class="badge bg-light text-dark border shadow-sm">${task.taskID}</span>
              </div>
              <div class="mt-2 text-end">${statusBadge}</div>
              <p class="text-muted small mt-2 mb-0 border-top pt-2">üìù ${task.desc}</p>
            </div>
            <div class="compare-grid">
              <div class="img-wrapper"><div style="font-size:0.8rem;margin-bottom:5px;">‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô</div><img src="${safeImg}" onclick="window.open(this.src)"></div>
              <div class="img-wrapper"><div style="font-size:0.8rem;margin-bottom:5px;">‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô</div><img id="preview_${task.taskID}" src="https://via.placeholder.com/300x300?text=‡∏£‡∏≠‡∏ñ‡πà‡∏≤‡∏¢"></div>
            </div>
            <div class="control-area">
              ${!isDone ? `<input type="file" id="file_${task.taskID}" class="form-control mb-3" accept="image/*" capture="environment" onchange="processImage(this, '${task.taskID}')">` : ''}
              <div id="msg_${task.taskID}" style="text-align:center;margin-bottom:10px;"><span class="status-pass">‚úÖ OK</span><span class="status-fail">‚ùå Error</span></div>
              <button type="button" id="btn_${task.taskID}" class="btn ${btnClass} w-100 shadow-sm" ${btnDisabled} onclick="submitTask('${task.taskID}', '${safeDept}')">${btnText}</button>
            </div>
          </div>`;
        container.insertAdjacentHTML('beforeend', html);
      });
    }

    function processImage(input, taskID) {
      const file = input.files[0];
      const preview = document.getElementById(`preview_${taskID}`);
      const btn = document.getElementById(`btn_${taskID}`);
      const pass = document.querySelector(`#msg_${taskID} .status-pass`);
      const fail = document.querySelector(`#msg_${taskID} .status-fail`);
      pass.style.display = 'none'; fail.style.display = 'none'; btn.disabled = true;

      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => preview.src = e.target.result;
        reader.readAsDataURL(file);
        EXIF.getData(file, function() {
          const dateTaken = EXIF.getTag(this, "DateTimeOriginal");
          if (!dateTaken) { showError(taskID, "‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ß‡∏•‡∏≤"); return; }
          pass.style.display = 'inline-block'; btn.disabled = false;
        });
      }
    }

    function showError(id, msg) { document.querySelector(`#msg_${id} .status-fail`).innerText = msg; document.querySelector(`#msg_${id} .status-fail`).style.display = 'block'; }

    function submitTask(taskID, dept) {
      const btn = document.getElementById(`btn_${taskID}`);
      const file = document.getElementById(`file_${taskID}`).files[0];
      if (!file) return;
      btn.innerHTML = 'Sending...'; btn.disabled = true;
      
      resizeImage(file, 1024, 0.7, function(resizedBase64) {
        google.script.run.withSuccessHandler(res => {
          if(res.success) { alert("‚úÖ Saved!"); location.reload(); } else { alert("‚ùå " + res.message); btn.disabled = false; }
        }).saveLog({ taskID: taskID, department: dept, imageBase64: resizedBase64 });
      });
    }

    function resizeImage(file, max, qual, cb) {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = function(e) {
        const img = new Image(); img.src = e.target.result;
        img.onload = function() {
          let w = img.width, h = img.height;
          if (w > max) { h = Math.round(h * (max / w)); w = max; }
          const c = document.createElement('canvas'); c.width = w; c.height = h;
          c.getContext('2d').drawImage(img, 0, 0, w, h);
          cb(c.toDataURL('image/jpeg', qual));
        };
      };
    }

    function showFatalError(err) {
      document.getElementById('loading-overlay').innerHTML = `<div class="p-4 text-center bg-white rounded shadow text-danger"><h4>‚ùå Error</h4><p>${err}</p><button class="btn btn-sm btn-outline-danger" onclick="location.reload()">Retry</button></div>`;
    }

    startApp();
  </script>
</body>
</html>
